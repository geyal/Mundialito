angular.module("security",[]).constant("security.urls",{site:"/",join:"/api/account/register",login:"/token",logout:"/api/account/logout",userInfo:"/api/account/userInfo",changePassword:"/api/account/changePassword",externalLogins:"/api/account/externalLogins",registerExternal:"/api/account/registerExternal"}).factory("security.api",["$http","security.urls",function(n,t){var i={"Content-Type":"application/x-www-form-urlencoded"},r=function(n){var t=function(n){var i="",e,f,r,u;return angular.forEach(n,function(n,o){if(n instanceof Array)for(u=0;u<n.length;++u)e=n[u],f=o+"["+u+"]",r={},r[f]=e,i+=t(r)+"&";else n instanceof Object?angular.forEach(n,function(n,u){f=o+"["+u+"]";r={};r[f]=n;i+=t(r)+"&"}):n!==undefined&&n!==null&&(i+=encodeURIComponent(o)+"="+encodeURIComponent(n)+"&")}),i.length?i.substr(0,i.length-1):i};return angular.isObject(n)&&String(n)!=="[object File]"?t(n):n};return{getUserInfo:function(i){return n({url:t.userInfo,method:"GET",headers:{Authorization:"Bearer "+i}})},login:function(u){return n({method:"POST",url:t.login,data:r(u),headers:i})},logout:function(){return n({method:"POST",url:t.logout})},register:function(i){return n({method:"POST",url:t.join,data:i})},changePassword:function(i){return n({method:"POST",url:t.changePassword,data:i})},getExternalLogins:function(){return n({method:"GET",url:t.externalLogins+"?returnUrl="+encodeURIComponent(t.site)+"&generateState=true",isArray:!0})},registerExternal:function(i,r){return n({method:"POST",url:t.registerExternal,data:r,headers:{Authorization:"Bearer "+i}})}}}]).provider("security",["security.urls",function(n){var t=this;t.registerThenLogin=!0;t.usePopups=!1;t.urls={login:"/login",registerExternal:"/registerExternal",postLogout:"/login",home:"/"};t.apiUrls=n;t.events={login:null,logout:null,register:null,reloadUser:null,closeOAuthWindow:null};t.$get=["security.api","$q","$http","$location","$timeout",function(n,i,r,u,f){var h=null,l=function(n){var u={},f,t,i,e,o,s,h,r;if(n===null)return u;for(f=n.split("&"),r=0;r<f.length;r++)t=f[r],i=t.indexOf("="),i===-1?(e=t,o=null):(e=t.substr(0,i),o=t.substr(i+1)),s=decodeURIComponent(e),h=decodeURIComponent(o),u[s]=h;return u},o=function(n,t){return n&&(n=="clear"?(localStorage.removeItem("accessToken"),sessionStorage.removeItem("accessToken"),delete r.defaults.headers.common.Authorization):(t?localStorage.accessToken=n:sessionStorage.accessToken=n,r.defaults.headers.common.Authorization="Bearer "+n)),sessionStorage.accessToken||localStorage.accessToken},s=function(n){if(n=="clear"){delete localStorage.redirectTarget;return}return n&&(localStorage.redirectTarget=n),localStorage.redirectTarget},c=function(r,f,h){var c=i.defer();return r.error?c.reject({message:r.error}):n.getUserInfo(r.access_token).success(function(n){n.hasRegistered?(o(r.access_token,h),e.user=n,e.redirectAuthenticated(s()||t.urls.home),t.events.login&&t.events.login(e,n),c.resolve(e.user)):(e.externalUser=n,e.externalUser.access_token=r.access_token,e.externalUser.provider=f,h!=null&&(localStorage.rememberMe=h),u.path(t.urls.registerExternal),c.reject())}),c.promise},a=function(){var i,f,r;u.path().indexOf("access_token")!=-1&&(i=l(u.path().substring(1)),u.path("/"),window.opener?(window.opener.external_data=i,window.close()):(f=JSON.parse(localStorage.loginProvider),r=!1,localStorage.rememberMe&&(r=JSON.parse(localStorage.rememberMe),delete localStorage.rememberMe),delete localStorage.loginProvider,c(i,f,r)));o()&&(o(o()),n.getUserInfo(o()).success(function(n){e.user=n;t.events.reloadUser&&t.events.reloadUser(e,n)}).error(function(){e.logout()}));n.getExternalLogins().success(function(n){e.externalLogins=n})},e=this;return e.user=null,e.externalUser=null,e.externalLogins=[],e.login=function(r){var u=i.defer();return r.grant_type="password",n.login(r).success(function(n){o(n.access_token,r.rememberMe);e.user=n;e.redirectAuthenticated(s()||t.urls.home);t.events.login&&t.events.login(e,n);u.resolve(e.user)}).error(function(n){u.reject(n)}),u.promise},e.loginWithExternal=function(n,r){var u=i.defer(),o;return t.usePopups?(o=window.open(n.url,"frame","resizeable,height=510,width=380"),f.cancel(h),h=f(function s(){if(!o.closed){h=f(s,500);return}if(t.events.closeOAuthWindow&&t.events.closeOAuthWindow(e,window.external_data),typeof window.external_data=="undefined"){u.reject();return}var i=window.external_data;delete window.external_data;u.resolve(c(i,n,r.rememberMe))},500)):(r!=null&&r.rememberMe!=null&&(localStorage.rememberMe=JSON.stringify(r.rememberMe)),localStorage.loginProvider=JSON.stringify(n),window.location.href=n.url),u.promise},e.logout=function(){var r=i.defer();return n.logout().success(function(){e.user=null;o("clear");s("clear");t.events.logout&&t.events.logout(e);u.path(t.urls.postLogout);r.resolve()}).error(function(n){o("clear");r.reject(n)}),r.promise},e.register=function(r){var u=i.defer();return n.register(r).success(function(){t.events.register&&t.events.register(e);t.registerThenLogin?e.login(r).then(function(n){u.resolve(n)},function(n){u.reject(n)}):u.resolve()}).error(function(n){u.reject(n)}),u.promise},e.registerExternal=function(){var t=i.defer();return e.externalUser?n.registerExternal(e.externalUser.access_token,e.externalUser).success(function(){t.resolve(e.loginWithExternal(e.externalUser.provider));e.externalUser=null}).error(function(n){t.reject(n)}):t.reject(),t.promise},e.changePassword=function(t){var r=i.defer();return n.changePassword(t).success(function(){r.resolve()}).error(function(n){r.reject(n)}),r.promise},e.authenticate=function(){o()||(s()||s(u.path()),u.path(t.urls.login))},e.redirectAuthenticated=function(n){o()&&(s()&&s("clear"),u.path(n))},a(),e}]}]);
/*
//# sourceMappingURL=angular-spa-security.min.js.map
*/